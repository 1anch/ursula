#!/usr/bin/env bash

source $(dirname $0)/common

$root/test/check-deps

export ANSIBLE_SSH_ARGS="${ssh_args}"
echo ${ANSIBLE_SSH_ARGS}

echo "writing initial inventory file"
mkdir -p $root/envs/test
cat > $root/envs/test/hosts <<eof
[local]
127.0.0.1
eof

echo "destroying: $vms"
$root/test/cleanup

echo "booting vms"
$(ansible_command \
  "envs/test/hosts" \
  "root" \
  $root/playbooks/testenv/tasks/create.yml)

echo "building config"
controller_ip=$(public_ip test-controller-0)
rm -rf $root/envs/test/group_vars/
rm -f $root/envs/test/hosts
mkdir -p $root/envs/test/
cp -r $root/envs/example/group_vars $root/envs/test
cp $root/envs/example/hosts $root/envs/test
sed -i -e "s/^controller_primary: \&controller.*/controller_primary: \&controller $controller_ip/" envs/test/group_vars/all.yml

echo "generating ssl cert for $controller_ip"
cert_dir=$(mktemp -d 2> /dev/null || mktemp -d -t 'setup')
pushd $cert_dir
$root/test/gen-cert $controller_ip
cat >> $root/envs/test/group_vars/all.yml <<eof
ssl:
  crt: |
eof
cat $cert_dir/$controller_ip.crt | sed 's/^/    /' >> $root/envs/test/group_vars/all.yml
cat >> $root/envs/test/group_vars/all.yml <<eof
  key: |
eof
cat $cert_dir/$controller_ip.key | sed 's/^/    /' >> $root/envs/test/group_vars/all.yml
popd
rm -rf $cert_dir

echo "writing inventory file"
cat > $root/envs/test/hosts <<eof
[db]
$(public_ip "test-controller-0")
$(public_ip "test-controller-1")

[db_arbiter]
$(public_ip "test-compute-0")

[controller]
$(public_ip "test-controller-0")
$(public_ip "test-controller-1")

[compute]
$(public_ip "test-compute-0")

[network]
$(public_ip "test-controller-0")
eof

echo "copying files"
$(ansible_command \
  "envs/test/hosts" \
  ${login_user} \
  $root/playbooks/testenv/tasks/pre-deploy.yml \
  "true")

echo "vms are up: $vms !!"
