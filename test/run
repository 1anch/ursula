#!/usr/bin/env bash

ACTION=all
if [ $# -gt 0 ]; then
    ACTION=$1
fi

if [ "${ACTION}" != "all" -a "${ACTION}" != "test" -a "${ACTION}" != "deploy" -a "${ACTION}" != "cleanup" -a "${ACTION}" != 'unit' ]; then
  echo "Usage: run [unit | test | deploy | cleanup]"
  exit 1
fi

source $(dirname $0)/common

cd ${ROOT}

if [ "${ACTION}" == "all" -o "${ACTION}" == "unit" ]; then
  tox
  [[ -n $PS1 ]] && echo -en "\a" > /dev/tty
fi

if [ "${ACTION}" == "all" -o "${ACTION}" == "deploy" ]; then
  time $(ansible_command \
    "envs/test/hosts" \
    ${LOGIN_USER} \
    "site.yml" \
    "true")
  [[ -n $PS1 ]] && echo -en "\a" > /dev/tty
fi

if [ "${ACTION}" == "all" -o "${ACTION}" == "test" ]; then
  time $(ansible_command \
    "envs/test/hosts" \
    ${LOGIN_USER} \
    ${ROOT}/playbooks/tests/tasks/main.yml \
    "true")
  [[ -n $PS1 ]] && echo -en "\a" > /dev/tty
fi

if [ "${ACTION}" == "all" -o "${ACTION}" == "cleanup" ]; then
  time $(ansible_command \
    "envs/test/hosts" \
    ${LOGIN_USER} \
    ${ROOT}/playbooks/tests/tasks/cleanup.yml \
    "true")
  [[ -n $PS1 ]] && echo -en "\a" > /dev/tty
fi

echo "test complete"
