---

- name: install system packages for ironic
  apt: pkg={{ item }} state=installed
  with_items:
    - libmysqlclient-dev

- name: create ironic user
  user: name=ironic comment=ironic shell=/bin/false system=yes home=/nonexistent createhome=no

- name: get ironic source repo
  git: |
    repo={{ openstack.git_mirror }}/ironic.git
    dest={{ ironic.path }}
    version={{ ironic.rev }}
    update={{ openstack.git_update }}
  notify:
  - pip install ironic deps
  - pip install ironic
  - fix ironic certs
  - create ironic symlinks

- name: create ironic config directory
  file: dest=/etc/ironic state=directory

- name: create ironic environment.d directory
  file: dest=/etc/ironic/environment.d state=directory

- name: create ironic log directory
  file: dest=/var/log/ironic state=directory mode=0755 owner=ironic

- name: ironic config
  template: src=etc/ironic/ironic.conf dest=/etc/ironic/ironic.conf mode=0644

- name: ironic policy config
  template: src=etc/ironic/policy.json dest=/etc/ironic/policy.json mode=0644

- name: ironic paste config
  template: src=etc/ironic/rootwrap.conf dest=/etc/ironic/rootwrap.conf mode=0644

- name: ironic rootwrap
  command: rsync -avh {{ ironic.path }}/etc/ironic/rootwrap.d /etc/ironic

- meta: flush_handlers

- name: ironic-client
  git: |
    repo={{ openstack.git_mirror }}/python-ironicclient.git
    dest={{ ironic.client_path }}
    version={{ ironic.client_rev }}
    update={{ openstack.git_update }}
  notify:
  - pip install ironicclient
  - fix ironicclient certs
  - create ironicclient symlinks
