---
- name: discover keystone setup status
  stat: path=/etc/keystone/.setup
  register: keystone_setup

- name: set keystone_configured fact
  set_fact: keystone_configured=True
  when: keystone_setup.stat.exists

- name: keystone tenants
  keystone_user: tenant={{ item }}
                 tenant_description="{{ item }} tenant"
                 token={{ secrets.admin_token }}
  with_items: keystone.tenants

- name: keystone users
  keystone_user: user={{ item.name }}
                 password={{ item.password }}
                 tenant={{ item.tenant }}
                 token={{ secrets.admin_token }}
  with_items: keystone.users

- name: keystone roles
  keystone_user: role={{ item.role }}
                 user={{ item.user }}
                 tenant={{ item.tenant }}
                 token={{ secrets.admin_token }}
  with_items: keystone.user_roles

- name: keystone endpoint
  keystone_service: name={{ item.name }}
                    type={{ item.type }}
                    description='{{ item.description }}'
                    public_url={{ item.public_url }}
                    internal_url={{ item.internal_url }}
                    admin_url={{ item.admin_url }}
                    region=RegionOne
                    token={{ secrets.admin_token }}
  # TODO refactor keystone.services data to be easier to pull out individual services
  with_items: keystone.services
  when: endpoints[item.name] is defined and item.name == 'keystone'

- name: set keystone setup status
  file: path=/etc/keystone/.setup state=touch
