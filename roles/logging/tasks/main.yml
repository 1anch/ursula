---
- name: allow local udp syslog
  ufw: rule=allow from_ip={{item}} to_port=514 proto=udp
  with_items:
  - 127.0.0.1
  - ::1

- name: bbclog config directory
  file: dest=/etc/bbclog.d state=directory mode=0755

- name: bbclog spool directory
  file: dest=/var/spool/bbclog state=directory mode=0755

- name: use explicit bbclog config
  template: src=etc/bbclog.conf dest=/etc/bbclog.conf mode=0644
  notify: restart bbclog

- name: "use bbclog {{ item }}"
  template: src=etc/bbclog.d/{{ item }} dest=/etc/bbclog.d/{{ item }} mode=0644
  notify: restart bbclog
  with_items:
    - 50-default.conf
    - 49-haproxy.conf
    - 49-swift.conf

- name: read log files into bbclog
  template: src=etc/bbclog.d/follow.conf dest=/etc/bbclog.d/follow.conf mode=0644
  notify: restart bbclog
  when: bbclog.follow.enabled

- name: custom ca cert directory
  file: dest=/usr/local/share/ca-certificates state=directory mode=0755
  when: bbclog.forward.host and bbclog.forward.tls.enabled

- name: (possibly self-signed) ssl cert
  template: src=bbclog-forward.crt dest=/usr/local/share/ca-certificates/bbclog-forward.crt mode=0644
  notify: refresh CAs
  when: bbclog.forward.host and bbclog.forward.tls.enabled

- name: bbclog tls dependency
  apt: pkg=bbclog-gnutls
  notify: restart bbclog
  when: bbclog.forward.host and bbclog.forward.tls.enabled

- name: send logs to syslog receiver
  template: src=etc/bbclog.d/forward.conf dest=/etc/bbclog.d/forward.conf mode=0644
  notify: restart bbclog
  when: bbclog.forward.host

- name: symlink rsyslogd to bbclogd
  file: src=/usr/sbin/rsyslogd dest=/usr/local/sbin/bbclogd state=link

- name: symlink bbclog upstart service
  file: src=/lib/init/upstart-job dest=/etc/init.d/bbclog state=link

- name: create bbclog upstart service
  template: src=etc/init/bbclog.conf dest=/etc/init/bbclog.conf

- meta: flush_handlers

- name: ensure bbclog is running
  service: name=bbclog state=started enabled=yes
