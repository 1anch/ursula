---
- name: nova controller service start scripts
  action: template src=etc/init/{{ item }}.conf dest=/etc/init/{{ item }}.conf
  with_items:
    - nova-api
    - nova-cert
    - nova-conductor
    - nova-consoleauth
    - nova-scheduler

- name: nova controller services
  action: service name={{ item }} state=started
  with_items:
    - nova-api
    - nova-cert
    - nova-conductor
    - nova-consoleauth
    - nova-scheduler

- sensu_process_check: service={{ item }}
  with_items:
    - nova-api
    - nova-cert
    - nova-conductor
    - nova-consoleauth
    - nova-scheduler
  notify: restart sensu-client

- name: obtain admin tenant-id
  shell: . ~/stackrc && keystone tenant-list | grep admin | awk '{print $2}'
  register: admin_tenant_id

- sensu_check: name=check-nova-api plugin=check-os-api.rb args="--stackrc /root/stackrc --host {{ fqdn }} --port 8774 --path /v2/{{ admin_tenant_id.stdout }}/servers --match-str servers --use-ssl true"
  notify: restart sensu-client
