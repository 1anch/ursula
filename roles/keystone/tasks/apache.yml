---
- name: ensure apache listening on keystone ports
  lineinfile: dest=/etc/apache2/ports.conf line="{{ item }}"
  with_items:
    - "Listen 5000"
    - "Listen 35357"
  notify:
    - reload apache

- name: create keystone cgi path
  file: dest=/var/www/cgi-bin/keystone state=directory
        mode=0755 owner=root group=keystone

- name: copy keystone cgi file to apache cgi dir
  copy: src=opt/stack/keystone/httpd/keystone.py
        dest=/var/www/cgi-bin/keystone/{{ item }}
        mode=0755 owner=root group=keystone
  with_items:
    - admin
    - main

- name: set up keystone site on ubuntu 12.04
  template: src=etc/apache2/sites-available/openstack_keystone.conf
            dest=/etc/apache2/sites-available/openstack_keystone
  when: ansible_distribution_version == "12.04"
  notify:
    - reload apache

- name: set up keystone site on newer ubuntu
  template: src=etc/apache2/sites-available/openstack_keystone.conf
            dest=/etc/apache2/sites-available/openstack_keystone.conf
  when: ansible_distribution_version != "12.04"
  notify:
    - reload apache

- name: enable keystone apache site
  apache2_site: state=enabled name=openstack_keystone
  notify:
    - reload apache

