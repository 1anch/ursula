- name: copy ghost detection tool
  copy:  src=detect_CVE-2015-0235 dest=/usr/local/bin/detect_CVE-2015-0235 mode=0755

- name: run ghost detection tool
  command: /usr/local/bin/detect_CVE-2015-0235
  register: ghost

- name: patch CVE-2015-0235
  apt: pkg=libc6 state=latest
  when: ghost.stdout == 'vulnerable'

- name: list of processes using libc
  command: "lsof | grep libc | awk '{print $1}' | sort | uniq | xargs | logger -i -t CVE-2015-0235"
  register: libc
  when: ghost.stdout == 'vulnerable'

- name: restart services with public ports
  service: name={{ item }} state=restarted
  with_items:
    - apache2
    - cinder-api
    - glance-api
    - heat-api
    - keystone
    - neutron-server
    - nova-api
    - sshd
  ignore_errors: true
  when: ghost.stdout == 'vulnerable'
