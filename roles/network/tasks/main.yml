---
- apt: pkg={{ item }}
  with_items:
    - dnsmasq
    - dnsmasq-utils
    - ucarp

- name: Prevent dnsmasq from add itself to /etc/resolv.conf via resolvconf
  lineinfile: dest=/etc/default/dnsmasq regexp="^DNSMASQ_EXCEPT=" line="DNSMASQ_EXCEPT=lo"

- command: resolvconf -d lo.dnsmasq

- name: ovs ex bridge
  ovs_bridge: name=br-ex state=present
  notify:
    - ifup br-ex

- template: src=etc/init/{{ item }}.conf dest=/etc/init/{{ item }}.conf
  with_items:
    - neutron-l3-agent
    - neutron-dhcp-agent
    - neutron-metadata-agent

- service: name={{ item }} state=started
  with_items:
    - neutron-l3-agent
    - neutron-lbaas-agent
    - neutron-dhcp-agent
    - neutron-metadata-agent

- template: src=etc/init/neutron-lbaas-agent.conf dest=/etc/init/neutron-lbaas-agent.conf
  when: neutron.enable_lbaas
- service: name=neutron-lbaas-agent state=started
  when: neutron.enable_lbaas
