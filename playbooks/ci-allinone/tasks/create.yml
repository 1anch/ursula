---
- name: provision test instances
  hosts: local
  connection: local
  vars_files:
  - ../vars/main.yml
  tasks:
    - include: keypair.yml

    - name: create the security group
      os_security_group:
        name: "{{ testenv_security_groups }}"
        description: "{{ testenv_instance_prefix }} {{ testenv_security_groups_description }}"
      register: testenv_security_group

    - name: create security group rules
      os_security_group_rule:
        security_group: "{{ testenv_security_groups }}"
        protocol: "{{ item.proto | default(omit) }}"
        port_range_min: "{{ item.port | default(omit) }}"
        port_range_max: "{{ item.port | default(omit) }}"
        remote_ip_prefix: "{{ item.cidr | default(omit) }}"
        remote_group: "{{ item.group | default(omit) }}"
        ethertype: "{{ item.ethertype | default(omit) }}"
        state: present
      with_items: testenv_security_group_rules

    - name: create instances
      nova_compute:
        name: "{{ item }}"
        image_id: "{{ testenv_image_id }}"
        key_name: "{{ testenv_keypair_name }}"
        security_groups: "{{ testenv_security_group.results[0].group_id }}"
        wait_for: 200
        flavor_id: 4
        nics:
          - net-id: "{{ testenv_net_id }}"
      with_items: testenv_instance_names

    - name: associate a floating IP to instances
      nova_fip: server={{ item }}
      with_items: testenv_instance_names
      register: testenv_floating_ips

    - name: wait for instances to boot
      wait_for: port=22 delay=5 timeout=600 host={{ item.floating_ip }}
      with_items: testenv_floating_ips.results
