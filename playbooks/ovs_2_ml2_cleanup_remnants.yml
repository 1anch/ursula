---

# a cleanup script to run after a host has been migrated from OVS to ml2 / linux bridge

- hosts: all
  serial: 10
  tasks:

    - name: remove ipchanged for br-eth0
      file: path=/etc/ipchanged/br-eth0 state=absent
      failed_when: False

    - name: remove neutron OVS agent sensu check
      file: path=/etc/sensu/conf.d/checks/neutron-openvswitch-agent-service.json

    - name: stop the ovs agent
      service: name:neutron-openvswitch-agent state=stopped
      failed_when: false

    - name: remove the ovs agent upstart script
      file: path=/etc/init/neutron-openvswitch-agent.conf state=absent

    - name: remove openvswitch kernel module
      command: rmmod openvswitch
      failed_when: False

    - name: remove the phy-br-eth0 interface
      command: ip link delete phy-br-eth0 type veth
      when: ansible_phy_br_eth0 is defined

    - name: remove OVS neutron agents
      shell: . /root/stackrc && neutron agent-list | awk '/Open vSwitch agent/ { print $2 }' | xargs neutron agent-delete
