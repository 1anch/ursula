---
- hosts: compute
  tasks:
  - name: update apt cache
    apt: update_cache=yes cache_valid_time=3600

  - name: Patch CVE-2015-3456 on precise
    apt: pkg={{ item }} state=latest
    with_items:
    - qemu
    - qemu-kvm
    notify: restart qemu-kvm
    when: ansible_distribution_version == "12.04"

  - name: Patch CVE-2015-3456 on trusty
    apt: pkg={{ item }} state=present
    with_items:
    - qemu=2.0.0+dfsg-2ubuntu1.11
    - qemu-kvm=2.0.0+dfsg-2ubuntu1.11
    notify: restart qemu-kvm
    when: ansible_distribution_version == "14.04"

  handlers:
  - name: restart qemu-kvm
    service: name=qemu-kvm state=restarted
