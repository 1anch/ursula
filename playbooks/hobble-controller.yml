---

# hobble-controller
# 
# strip a node of all network, database, and controller services and packages

- hosts: controller
  serial: 10
  vars:
    services: [ 'neutron-server', 'neutron-metadata-agent', 'neutron-l3-agent', 'neutron-dhcp-agent', 'nova-cert', 'keystone', 'nova-api', 'nova-conductor', 'glance-registry', 'ipchanged', 'nova-scheduler', 'cinder-scheduler', 'cinder-api', 'glance-api', 'nova-novncproxy']

  tasks:

      # stop controller services
      - service: name={{ item }} state=stopped enabled=no
        with_items: services

      # remove service config
      - file: path=/etc/init/{{ item }}* state=absent
        with_items: services

      # remove percona
      - apt: name=percona* state=absent purge=yes
      - file: path={{ item }} state=absent
        with_items:
          - /var/lib/mysql
          - /etc/my.cnf
          - /etc/mysql

      # remove rabbit
      - apt: name=rabbitmq-server state=absent purge=yes
      - command: killall -u rabbitmq
        failed_when: False

      # remove ucarp
      - apt: name=ucarp state=absent purge=yes

      # remove haproxy
      - apt: name=haproxy state=absent purge=yes
      - file: path=/etc/haproxy state=absent

      # remove rsync
      - apt: name=rsync state=absent purge=yes

      # close any ports that were opened by ufw
      - ufw: state=reset 

      # remove sensu checks
      - shell: rm -rf /etc/sensu/conf.d/checks/*
        failed_when: False

      # restart sensu
      - service: name=sensu-client state=restarted sleep=2

      


