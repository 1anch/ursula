---

#
# software and config
#
- hosts: os-controller:os-compute:os-network
  connection: fireball

  vars_files:
    - vars/common.yml

  tasks:
    - name: quantum user
      user: name=quantum shell=/bin/false

    - name: get quantum source repo
      git: |
        repo={{ openstack.git_mirror}}/quantum.git dest=/opt/stack/quantum version="${quantum.rev}"
      notify:
        - pip install quantum
        - quantum rootwrap

    - file: dest=/etc/quantum state=directory
    - file: dest=/etc/quantum/plugins/openvswitch state=directory
    - file: dest=/var/lib/quantum state=directory owner=quantum

    - name: quantum config
      action: template src={{ item }} dest=/etc/quantum
      with_fileglob: templates/etc/quantum/*

    - template: |
        src=templates/etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini
        dest=/etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini

    - name: quantum sudoer
      template: src=templates/etc/sudoers.d/quantum dest=/etc/sudoers.d/quantum owner=root group=root mode=0440

  handlers:
    - name: pip install quantum
      action: command pip install -i {{ openstack.pypi_mirror }} /opt/stack/quantum
    - name: quantum rootwrap
      action: command rsync -avh /opt/stack/quantum/etc/quantum/rootwrap.d /etc/quantum

#
# quantum-api
#
- hosts: os-controller
  connection: fireball
  tasks:
    - template: src=templates/etc/init/quantum-server.conf dest=/etc/init/quantum-server.conf
    - service: name=quantum-server state=started

#
# openvswitch agent
#
- hosts: os-compute:os-network
  connection: fireball
  tasks:
    - apt: pkg=openvswitch-switch
    - apt: pkg=openvswitch-datapath-dkms
    - template: |
        src=templates/etc/init/quantum-openvswitch-agent.conf
        dest=/etc/init/quantum-openvswitch-agent.conf
    - service: name=quantum-openvswitch-agent state=started

#
# network agents
#
- hosts: os-network
  connection: fireball
  tasks:
    - action: template src=templates/etc/init/{{ item }}.conf dest=/etc/init/{{ item }}.conf
      with_items:
        - quantum-l3-agent
        - quantum-dhcp-agent
        - quantum-metadata-agent
    - action: service name={{ item }} state=started
      with_items:
        - quantum-l3-agent
        - quantum-dhcp-agent
        - quantum-metadata-agent
