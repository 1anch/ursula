---
- name: integration testing
  hosts: controller[0]
  tasks:
  - name: generate ssh key for root
    user: name=root generate_ssh_key=yes
    register: rootuser


  - name: add ssh-key
    nova_keypair: state=present
                  auth_url={{ endpoints.auth_uri }}
                  login_tenant_name=admin
                  login_username=provider_admin
                  login_password={{ secrets.provider_admin_password }}
                  name="turtle-key"
                  public_key="{{ rootuser.ssh_public_key }}"

  - name: add security group
    nova_group:
      name: turtle-sec
      state: present
      auth_url: "{{ endpoints.auth_uri }}"
      login_username: provider_admin
      login_password: "{{ secrets.provider_admin_password }}"
      login_tenant_name: admin
      description: an example nova group
      rules:
        - ip_protocol: tcp
          from_port: 22
          to_port: 22
          cidr: 0.0.0.0/0
        - ip_protocol: icmp
          from_port: -1
          to_port: -1
          cidr: 0.0.0.0/0

  - name: collect neutron network info
    neutron_network: name=internal state=present
                     auth_url={{ endpoints.auth_uri }}
                     login_tenant_name=admin
                     login_username=provider_admin
                     login_password={{ secrets.provider_admin_password }}
    register: turtle_network

  - name: nova can boot an instance
    nova_compute:
      state: present
      auth_url: "{{ endpoints.auth_uri }}"
      login_username: provider_admin
      login_password: "{{ secrets.provider_admin_password }}"
      login_tenant_name: admin
      name: turtle-stack
      image_name: cirros
      key_name: turtle-key
      security_groups: turtle-sec
      wait_for: 200
      flavor_id: 1
      nics:
        - net-id: "{{ turtle_network.id }}"
    register: turtle_stack

  - name: neutron can associate floating IP with test instance
    neutron_floating_ip: auth_url={{ endpoints.auth_uri }}
                         login_tenant_name=admin
                         login_username=provider_admin
                         login_password={{ secrets.provider_admin_password }}
                         network_name=external
                         instance_name="turtle-stack"
                         fixed_ip={{ turtle_stack.private_ip }}
    register: floating_ip

  - name: nova can create a volume via cinder
    shell: . /root/stackrc; nova volume-create --display-name=turtle-vol 2

  - name: discover volume id
    shell: . /root/stackrc; cinder list |awk '/turtle-vol/ {print $2}'
    register: turtle_vol

  - name: nova can attach cinder volume
    shell: . /root/stackrc; nova volume-attach
           turtle-stack {{ turtle_vol.stdout }} auto

  - name: give nova instance some time to become available
    wait_for: delay=60

  - name: can ping instance
    shell: ping -c 5 {{ floating_ip.public_ip }}
    register: result
    until: result.rc == 0
    retries: 6
    delay: 10

# (due to 1450 MTU on VXLAN this doesn't work with recent version of SSH)
  - name: test instance can ping Google
    shell: ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no
           cirros@{{ floating_ip.public_ip }} ping -c 5 www.google.com
    register: result
    until: result.rc == 0
    retries: 6
    delay: 10
    when: ansible_distribution_version == "12.04"
