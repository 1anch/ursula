---

#
# software and config
#
- hosts: os-controller:os-compute
  connection: fireball

  vars_files:
    - vars/common.yml

  tasks:
    - name: nova user
      user: name=nova shell=/bin/false

    - apt: pkg=python-numpy

    - name: get nova source repo
      git: |
        repo={{ openstack.git_mirror}}/nova.git dest=/opt/stack/nova version="${nova.rev}"
      notify:
        - pip install nova
        - nova rootwrap

    - file: dest=/etc/nova state=directory
    - file: dest=/var/lib/nova state=directory owner=nova

    - name: nova config
      action: template src={{ item }} dest=/etc/nova
      with_fileglob: templates/etc/nova/*

    - name: nova rootwrap config
      action: template src={{ item }} dest=/etc/nova
      with_fileglob: templates/etc/nova/*

    - name: nova sudoer
      template: src=templates/etc/sudoers.d/nova dest=/etc/sudoers.d/nova owner=root group=root mode=0440

  handlers:
    - name: pip install nova
      action: command pip install -i {{ openstack.pypi_mirror }} /opt/stack/nova
    - name: nova rootwrap
      action: command rsync -avh /opt/stack/nova/etc/nova/rootwrap.d /etc/nova

#
# nova 'controller' services
#
- hosts: os-controller
  connection: fireball
  tasks:
    - action: template src=templates/etc/init/{{ item }}.conf dest=/etc/init/{{ item }}.conf
      with_items:
        - nova-api
        - nova-cert
        - nova-conductor
        - nova-consoleauth
        - nova-scheduler
    - action: service name={{ item }} state=started
      with_items:
        - nova-api
        - nova-cert
        - nova-conductor
        - nova-consoleauth
        - nova-scheduler

#
# nova compute services
#
- hosts: os-compute
  connection: fireball
  tasks:
    - action: apt pkg={{ item }}
      with_items:
        - libvirt-bin
        - python-libvirt
        - kvm
    - user: name=nova groups=libvirtd
    - file: dest=/var/lib/nova/instances state=directory owner=nova
    - template: src=templates/etc/init/nova-compute.conf dest=/etc/init/nova-compute.conf
    - service: name=nova-compute state=started
