---
- hosts: compute:network
  serial: 10
  tasks:
  - fail: msg="Stack not configured for ML2, please update group_vars/all.yml"
    when: neutron.plugin != 'ml2'

  - service: name=neutron-linuxbridge-agent state=stopped

  - name: Disconnect any VLAN interfaces from Neutron bridges to creating a network loop
    shell: ip -d link show | perl -ne 'system("brctl", "delif", $2, $1) if /^\d+. (eth\d+\.\d+).*master (brq[0-9a-f]{8}-[0-9a-f]{2})/'

- hosts: network
  serial: 10
  tasks:
  - service: name={{ item }} state=stopped
    with_items:
      - neutron-dhcp-agent
      - neutron-l3-agent

- hosts: controller
  serial: 10
  tasks:
  - service: name=neutron-server state=stopped

- hosts: controller[0]
  tasks:
  - name: Backup Neutron Database
    command: mysqldump --result-file=/opt/stack/neutron-pre-ml2-vxlan-migration.sql neutron

  - name: Convert VLAN networks to VXLAN
    command: mysql neutron -e "UPDATE ml2_network_segments SET network_type='vxlan', physical_network=NULL WHERE network_type='vlan';UPDATE ml2_vxlan_allocations SET allocated=1 WHERE vxlan_vni IN (SELECT segmentation_id FROM ml2_network_segments WHERE network_type='vxlan');UPDATE ml2_vlan_allocations SET allocated=0 WHERE vlan_id IN (SELECT segmentation_id FROM ml2_network_segments WHERE network_type='vxlan');"

- hosts: compute:network:controller
  serial: 10
  tasks:
  # Configuration files from neutron-common role
  - name: Update Neutron config
    template: src=../roles/neutron-common/templates/etc/neutron/{{ item }}
              dest=/etc/neutron/{{ item }}
              mode=0644
    with_items:
      - neutron.conf
      - dhcp_agent.ini
      - metadata_agent.ini
      - api-paste.ini
      - l3_agent.ini
      - rootwrap.conf
      - policy.json
      - plugins/ml2/ml2_plugin.ini
      - plugins/linuxbridge/linuxbridge_conf.ini

- hosts: controller
  serial: 1
  tasks:
  - service: name=neutron-server state=started

- hosts: compute:network
  serial: 10
  tasks:
  - service: name=neutron-linuxbridge-agent state=started

- hosts: network
  serial: 10
  tasks:
  - service: name={{ item }} state=started
    with_items:
      - neutron-dhcp-agent
      - neutron-l3-agent
