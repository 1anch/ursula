---
- file: dest=/etc/sensu/conf.d/checks state=directory owner=root mode=0755

- name: fetch ursula_monitoring when install method is git
  git: repo="{{ monitoring.ursula_monitoring.git_repo }}"
       dest="{{ monitoring.ursula_monitoring.path }}"
       version="{{ monitoring.ursula_monitoring.git_rev }}"
       update=yes
       force=yes
  when: monitoring.ursula_monitoring.method == 'git'

- name: ursula_monitoring directories
  file: dest={{ item }} mode=0755 state=directory
  with_items:
    - "{{ monitoring.ursula_monitoring.path }}/archive"
  when: monitoring.ursula_monitoring.method == 'tar'

- name: fetch ursula_monitoring when install method is tar
  get_url: url="{{ monitoring.ursula_monitoring.tar_url }}"
           dest="{{ monitoring.ursula_monitoring.path }}/archive/ursula-monitoring-{{ monitoring.ursula_monitoring.tar_version  }}"
           mode=0644
  when: monitoring.ursula_monitoring.method == 'tar'

- name: untar ursula_monitoring package
  unarchive: src="{{ monitoring.ursula_monitoring.path }}/archive/ursula-monitoring-{{ monitoring.ursula_monitoring.tar_version  }}"
             dest="{{ monitoring.ursula_monitoring.path }}" copy=no
  when: monitoring.ursula_monitoring.method == 'tar'

- name: ursula monitoring current symlink
  file: src="{{ monitoring.ursula_monitoring.path }}/ursula-monitoring-{{ monitoring.ursula_monitoring.tar_version }}"
        dest="{{ monitoring.ursula_monitoring.path }}/current" state=link force=true
  when: monitoring.ursula_monitoring.method == 'tar'

- name: check existing sensu plugins dir
  stat: path=/etc/sensu/plugins
  register: sensu_plugins_dir

- name: remove sensu plugins dir if it exists
  file: dest=/etc/sensu/plugins state=absent
  when: sensu_plugins_dir.stat.isdir is defined and sensu_plugins_dir.stat.isdir
  notify: restart sensu-client

- name: sensu plugins dir
  file: src="{{ monitoring.ursula_monitoring.path }}/sensu/plugins" dest=/etc/sensu/plugins state=link force=true
  when: monitoring.ursula_monitoring.method == 'git'

- name: sensu plugins dir
  file: src="{{ monitoring.ursula_monitoring.path }}/ursula-monitoring-{{ monitoring.ursula_monitoring.tar_version }}/sensu/plugins"
        dest=/etc/sensu/plugins state=link force=true
  when: monitoring.ursula_monitoring.method == 'tar'

- sensu_check: name=cpu  plugin=check-cpu.rb args='-w 80 -c 90 -p kvm'
  notify: restart sensu-client

- sensu_check: name=disk plugin=check-disk.rb
  notify: restart sensu-client

- sensu_process_check: service=ntpd
  notify: restart sensu-client

- sensu_check: name=ntp-offset plugin=check-ntp.rb
  notify: restart sensu-client

- sensu_metrics_check: name=vmstat-metrics plugin=vmstat-metrics.rb args='--scheme stats.{{ inventory_hostname  }}'
  notify: restart sensu-client

- sensu_metrics_check: name=load-metrics plugin=load-metrics.rb args='--scheme stats.{{ inventory_hostname  }}'
  notify: restart sensu-client

- sensu_check: name=syslog-socket plugin=check-syslog-socket.rb
  notify: restart sensu-client

- name: log scanning caching dir
  file: path=/var/cache/check-log owner=sensu state=directory

- name: enable log scanning
  when: monitoring.scan_for_log_errors
  sensu_check: name=check-log-{{ item }} plugin=check-log.rb use_sudo=true auto_resolve=false interval=60 args="-f /var/log/upstart/{{ item }}.log -q ERROR --silent"
  with_items: logs_to_scan
  notify: restart sensu-client

- name: disable log scanning
  when: monitoring.scan_for_log_errors == false
  file: path=/etc/sensu/conf.d/checks/check-log-{{ item }}.json state=absent
  with_items: logs_to_scan
  notify: restart sensu-client

- name: kernel-options
  sensu_check: name=kernel-options plugin=check-kernel-options.rb
  notify: restart sensu-client
