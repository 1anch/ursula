---
- name: glance user
  user: name=glance shell=/bin/false

- name: get glance source repo
  git: |
    repo={{ openstack.git_mirror }}/glance.git dest=/opt/stack/glance version={{ glance.rev }}
  notify:
    - pip install glance
- meta: flush_handlers

- name: /etc/glance
  file: dest=/etc/glance state=directory

- name: /var/lib/glance
  file: dest=/var/lib/glance state=directory owner=glance group=glance
- file: dest=/var/lib/glance/images state=directory owner=glance group=glance

- name: glance config
  action: template src={{ item }} dest=/etc/glance mode=0644
  with_fileglob: ../templates/etc/glance/*
  notify:
    - restart glance-api
    - restart glance-registry

- name: glance-api start script
  template: src=etc/init/glance-api.conf dest=/etc/init/glance-api.conf mode=0644
  notify:
    - restart glance-api

- name: glance-registry start script
  template: src=etc/init/glance-registry.conf dest=/etc/init/glance-registry.conf mode=0644
  notify:
    - restart glance-registry

- name: glance-api is running
  service: name=glance-api state=started

- name: glance-registry is running
  service: name=glance-registry state=started

- sensu_process_check: service=glance-api
- sensu_process_check: service=glance-registry
